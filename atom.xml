<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  
  <title><![CDATA[Diary of a Chump]]></title>
  <subtitle><![CDATA[sdgluck's blog]]></subtitle>
  <link href="/atom.xml" rel="self"/>
  <link href="sdgluck.github.io//"/>
  <updated>2015-08-29T07:32:23.793Z</updated>
  <id>sdgluck.github.io//</id>
  
  <author>
    <name><![CDATA[Sam Gluck]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[What is requestIdleCallback?]]></title>
    <link href="sdgluck.github.io/2015/08/29/request-idle-callback/"/>
    <id>sdgluck.github.io/2015/08/29/request-idle-callback/</id>
    <published>2015-08-29T08:20:00.000Z</published>
    <updated>2015-08-29T07:32:23.793Z</updated>
    <content type="html"><![CDATA[<blockquote><p>In the same way that adopting requestAnimationFrame allowed us to schedule animations properly and maximize our chances of hitting 60fps, requestIdleCallback will schedule work when there is free time at the end of a frame, or when the user is inactive.</p>
<footer><strong>Paul Lewis</strong><cite>Google</cite></footer></blockquote>
<a id="more"></a>
<h2 id="Glossary">Glossary</h2><p><strong>1.0 <a href="#section1">Why?</a></strong><br><strong>2.0 <a href="#section2">How?</a></strong><br>&nbsp;&nbsp;&nbsp;<strong>2.1</strong> <a href="#section2.1">The <code>requestIdleCallback</code> Function</a><br>&nbsp;&nbsp;&nbsp;<strong>2.2</strong> <a href="#section2.2">Deadline Object and the Idle <code>timeRemaining</code> Property</a><br>&nbsp;&nbsp;&nbsp;<strong>2.3</strong> <a href="#section2.3">Wrapping rIC with Promises</a><br><strong>4.0 <a href="#section4">Availability</a></strong><br><strong>5.0 <a href="#section5">References</a></strong></p>
<p><span id="section1"></span></p>
<h2 id="1-_Why?">1. Why?</h2><p>As JavaScript is executed on a single thread any computation causes the application to <em>wait</em> until it has completed before moving on and performing another. There is no standard for delaying execution of a procedure until the environment is idle… until now! When an environment is idle can be the best time to execute tasks that don’t make an immediate and obvious contribution to the user’s experience. With  <code>requestIdleCallback</code> <a href="#[1]">[1]</a> we can supply a callback to be invoked when the environment isn’t occupied with anything else and therefore avoid interupting user interactions. </p>
<p><span id="section2"></span></p>
<h2 id="2-_How?">2. How?</h2><p><span id="section2.1"></span></p>
<h3 id="2-1_The_requestIdleCallback_Function">2.1 The <code>requestIdleCallback</code> Function</h3><p>We simply pass an anonymous function or function reference to <code>requestIdleCallback</code>. We also have the option of a second argument that specifies the <em>maximum amount of time</em> to wait before executing the callback outright, regardless of whether the browser is idle. This is really useful for tasks that are necessary without requiring immediate attention.</p>
<figure class="highlight js"><figcaption><span>Using the requestIdleCallback function</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Passing an anonymous function</span></span><br><span class="line"><span class="comment">// -----------------------------</span></span><br><span class="line">requestIdleCallback(<span class="function"><span class="keyword">function</span> <span class="title">someHeavyComputation</span>(<span class="params">deadline</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// do some heavy work...</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Passing reference to a method</span></span><br><span class="line"><span class="comment">// -----------------------------</span></span><br><span class="line"><span class="keyword">let</span> someObject = &#123;&#125;;</span><br><span class="line">someObject.someHeavyComputation = <span class="function"><span class="keyword">function</span> <span class="title">someHeavyComputation</span>(<span class="params">deadline</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// do some heavy work...</span></span><br><span class="line">&#125;;</span><br><span class="line">requestIdleCallback(someObject.someHeavyComputation);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Passing anonymous function with a timeout</span></span><br><span class="line"><span class="comment">// -----------------------------------------</span></span><br><span class="line">requestIdleCallback(<span class="function"><span class="keyword">function</span> <span class="title">someHeavyComputation</span>(<span class="params">deadline</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// do some heavy work...</span></span><br><span class="line">&#125;, <span class="number">5000</span>);</span><br></pre></td></tr></table></figure>
<p><span id="section2.2"></span></p>
<h3 id="2-2_Deadline_Object">2.2 Deadline Object</h3><p>You may have noticed in each of the examples above that the callback is invoked with a single argument <code>deadline</code>. This is an object with two properties: <code>timeRemaining</code> and <code>didTimeout</code>.</p>
<h4 id="timeRemaining">timeRemaining</h4><p><code>timeRemaining</code> contains the amount of time that the function has left before the environment is no longer idle (in <em>milliseconds</em>). It is updated dynamically and so can be inspected within the procedure via a <code>while</code> loop or similar such that it will only perform its operations during the available idle window. This is necessary because as with any function the browser cannot prematurely destroy your callback. You are therefore responsible for ending execution of the callback (via a <code>return</code>) at an appropriate time (<code>timeRemaining &gt;= 0</code>) so that it does not occupy more than is reported by the browser as being idle! If you don’t do this you will start muscling in on time that would have been used for other operations.</p>
<figure class="highlight js"><figcaption><span>Ensuring continued execution of idle work callback</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">requestIdleCallback(<span class="function"><span class="keyword">function</span> <span class="title">someHeavyComputation</span>(<span class="params">deadline</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(deadline.timeRemaining &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// do some heavy work...</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(thereIsMoreWorkToDo) &#123;</span><br><span class="line">        requestIdleCallback(someHeavyComputation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<pre>

</pre>

<h4 id="didTimeout">didTimeout</h4><p><code>didTimeout</code> is a boolean that if <code>true</code> means that the callback has been invoked because an idle window was not available within the deadline provided via <code>requestIdleCallback</code>‘s second argument. If you have provided this argument and the amount of time declared by it has passed you will want to perform the callback’s work by checking the <code>didTimeout</code> property and doing the work regardless.</p>
<figure class="highlight js"><figcaption><span>Checking if request timed out</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Declare callback to be invoked after two seconds if</span></span><br><span class="line"><span class="comment">// no idle window is available within that time</span></span><br><span class="line">requestIdleCallback(<span class="function"><span class="keyword">function</span> <span class="title">someHeavyWork</span>(<span class="params">deadline</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(deadline.timeRemaining &gt; <span class="number">0</span> || deadline.didTimeout) &#123;</span><br><span class="line">        <span class="comment">// do some heavy work...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="number">2000</span>);</span><br></pre></td></tr></table></figure>
<p><span id="section2.3"></span></p>
<h3 id="2-3-_Wrapping_rIC_with_Promises">2.3. Wrapping rIC with Promises</h3><p>You can of course execute any code within a <code>requestIdleCallback</code> (rIC), but if the operation you are performing is computationally expensive and will therefore take <em>a long time</em> to complete, consider wrapping it in a Promise <a href="#[2]">[2]</a>. Doing this will abstract a linear operation that would otherwise be blocking and will make it obviously asynchronous.</p>
<figure class="highlight js"><figcaption><span>Wrapping requestIdleCallback with a Promise</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">factorial</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!(<span class="string">'requestIdleCallback'</span> <span class="keyword">in</span> <span class="built_in">window</span>)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'requestIdleCallback is not available in this environment'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Wrap the call to requestIdleCallback in a Promise</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> start = <span class="built_in">Date</span>.now();</span><br><span class="line">        <span class="keyword">let</span> n = input - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">let</span> result = input;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// First call to start the work in the next idle window</span></span><br><span class="line">        requestIdleCallback(next);</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">deadline</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(deadline.timeRemaining &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                requestIdleCallback(next);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            result *= n--;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(n &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// Calculation has completed, `resolve` the Promise</span></span><br><span class="line">                <span class="keyword">return</span> resolve(&#123; </span><br><span class="line">                    num: result, </span><br><span class="line">                    time: (<span class="built_in">Date</span>.now() - start) / <span class="number">1000</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Perform the next calculation, passing in the `deadline`</span></span><br><span class="line">            <span class="comment">// again so that the function knows not to continue</span></span><br><span class="line">            <span class="comment">// if the `timeRemaining` is zero</span></span><br><span class="line">            next(deadline);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Calculate the factorial of 20 asynchronously</span></span><br><span class="line">factorial(<span class="number">20</span>)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(</span><br><span class="line">            <span class="string">'Result: '</span> + result.num, <span class="comment">// 2432902008176640000</span></span><br><span class="line">            <span class="string">'Execution time: '</span> + result.time + <span class="string">'s'</span></span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// heavy work done...</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// handle error...</span></span><br><span class="line">        <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p><span id="section4"></span></p>
<h2 id="4-_Availability">4. Availability</h2><p>Currently this feature is only available in Chrome Canary (with <em>chrome://flags/#enable-experimental-web-platform-features</em> enabled). But there have been talks with the other browser vendors Microsoft and Apple about implementing this in their own browsers. <a href="#[3]">[3]</a></p>
<table>
<thead>
<tr>
<th>Chrome (Canary)</th>
<th>Firefox</th>
<th>Safari</th>
<th>Opera</th>
</tr>
</thead>
<tbody>
<tr>
<td><span style="color: green;">Yes</span></td>
<td><span style="color: red;">No</span></td>
<td><span style="color: red;">No</span></td>
<td><span style="color: red;">No</span></td>
</tr>
</tbody>
</table>
<p><span></span><br>While availablity is poor you will need to always check that the <code>requestIdleCallback</code> API is available with a simple <em>if</em> block.</p>
<figure class="highlight js"><figcaption><span>Checking for requestIdleCallback on window</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">'requestIdleCallback'</span> <span class="keyword">in</span> <span class="built_in">window</span>) &#123;</span><br><span class="line">    <span class="built_in">window</span>.requestIdleCallback(someFunctionToCall);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'requestIdleCallback not available in this environment'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><span id="section5"></span></p>
<h2 id="5-_References">5. References</h2><p>[1] <a href="https://developers.google.com/web/updates/2015/08/27/using-requestidlecallback" target="_blank" rel="external">“Using requestIdleCallback” on the Google Developers Blog</a><br>[2] <a href="https://sdgluck.github.io/2015/08/24/promise-ponderings-patterns-apologies/">Promise Ponderings, (Anti-)Patterns, and Apologies</a><br>[3] <a href="https://twitter.com/aerotwist/status/636914862082400256" target="_blank" rel="external">Paul Lewis on Twitter</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<blockquote><p>In the same way that adopting requestAnimationFrame allowed us to schedule animations properly and maximize our chances of hitting 60fps, requestIdleCallback will schedule work when there is free time at the end of a frame, or when the user is inactive.</p>
<footer><strong>Paul Lewis</strong><cite>Google</cite></footer></blockquote>]]>
    
    </summary>
    
      <category term="chrome" scheme="sdgluck.github.io/tags/chrome/"/>
    
      <category term="javascript" scheme="sdgluck.github.io/tags/javascript/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Promise Ponderings, (Anti-)Patterns, and Apologies]]></title>
    <link href="sdgluck.github.io/2015/08/24/promise-ponderings-patterns-apologies/"/>
    <id>sdgluck.github.io/2015/08/24/promise-ponderings-patterns-apologies/</id>
    <published>2015-08-24T16:16:00.000Z</published>
    <updated>2015-08-29T07:55:16.486Z</updated>
    <content type="html"><![CDATA[<p>If you aren’t familiar with Promises or you have used them but don’t know <em>why</em>, then I hope this article will help you. Because “Promises are confusing.” And like any programming construct, having a good grasp of its behaviour comes from understanding what a Promise is built to do, not just <em>how to use them</em>. In this article I want to discuss some ways to utilise the “power of the Promise” and explain that in some cases unexpected or unusual behaviour is a feature of the language, not a “bug in the Matrix”. We will also discuss some common anti-patterns; what they are, why they are potentially dangerous, and how to avoid them.</p>
<blockquote><p>Give us this day our daily Promise,<br>and forgive us our asynchronicity,<br>as we forgive those who nested too many callbacks,<br>and lead us not into Callback Hell,<br>but deliver us from evil,<br>for thine is the JavaScript,<br>and the power, and the glory,<br>for ever and ever,<br>ECMA</p>
</blockquote>
<h2 id="Glossary">Glossary</h2><p><strong>1.0 <a href="#section1">Promises</a></strong><br><strong>2.0 <a href="#section2">Ponderings</a></strong><br>&nbsp;&nbsp;&nbsp;<strong>2.1</strong> <a href="#section2.1">“What do <code>resolve</code> and <code>reject</code> mean?”</a><br>&nbsp;&nbsp;&nbsp;<strong>2.2</strong> <a href="#section2.2">“What is the difference between <code>new Promise()</code> and <code>Promise#then</code>?”</a><br>&nbsp;&nbsp;&nbsp;<strong>2.3</strong> <a href="#section2.3">“What can I give <code>Promise#then</code>? Does it accept a <code>new Promise</code>?”</a><br>&nbsp;&nbsp;&nbsp;<strong>2.4</strong> <a href="#section2.4">“What happens if I don’t <code>resolve</code> a <code>Promise</code>?”</a><br>&nbsp;&nbsp;&nbsp;<strong>2.5</strong> <a href="#section2.5">“What affect does <code>reject</code>ing a Promise have?”</a><br>&nbsp;&nbsp;&nbsp;<strong>2.6</strong> <a href="#section2.6">“If I <code>throw</code> an Error, where will it go?”</a><br>&nbsp;&nbsp;&nbsp;<strong>2.7</strong> <a href="#section2.7">“Should I <code>throw</code> an Error in a <code>new Promise()</code> or call the <code>reject</code> function?”</a><br>&nbsp;&nbsp;&nbsp;<strong>2.8</strong> <a href="#section2.8">“Is <code>throw</code>ing the same as <code>reject</code>ing?”</a><br>&nbsp;&nbsp;&nbsp;<strong>2.9</strong> <a href="#section2.9">“Why isn’t my <code>Promise</code>‘s error handler being invoked?”</a><br>&nbsp;&nbsp;&nbsp;<strong>2.10</strong> <a href="#section2.10">“Why is my <code>Promise</code> ‘pending’ when I have already resolved it?”</a><br>&nbsp;&nbsp;&nbsp;<strong>2.11</strong> <a href="#section2.11">“Generally, what rules should I follow for handling errors?”</a><br><strong>3.0 <a href="#section3">Patterns</a></strong><br>&nbsp;&nbsp;&nbsp;<strong>3.1</strong> <a href="#section3.1">Batching with <code>Array#map</code> and <code>Promise.all</code></a><br>&nbsp;&nbsp;&nbsp;<strong>3.2</strong> <a href="#section3.2">Clean Chaining</a><br>&nbsp;&nbsp;&nbsp;<strong>3.3</strong> <a href="#section3.3">Throwing Instead of Rejecting</a><br><strong>4.0 <a href="#section4">Anti-Patterns</a></strong><br>&nbsp;&nbsp;&nbsp;<strong>4.1</strong> <a href="#section4.1">Deferring a Promise</a><br>&nbsp;&nbsp;&nbsp;<strong>4.2</strong> <a href="#section4.2">Nesting Promises</a><br>&nbsp;&nbsp;&nbsp;<strong>4.3</strong> <a href="#section4.3">The Non-Returning Promise</a><br><strong>5.0 <a href="#section5">Apologies</a></strong><br><strong>6.0 <a href="#section6">References</a></strong></p>
<p><span id="section1"></span></p>
<h2 id="1-_Promises">1. Promises</h2><p><strong>Why?</strong> Asynchronous development means passing control between multiple contexts frequently. This results in quite confusing code, as anonymous function declarations dominate the codebase and make it difficult to follow. Promises are a way of organising asynchronous operations in such a way that they appear synchronous and we can therefore leverage them to save us from feared Callback Hell <a href="#[1]">[1]</a>.</p>
<figure class="highlight js"><figcaption><span>Patience is a virtue</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Are ya ready, kids?!'</span>);</span><br><span class="line">    setTimeout(resolve, <span class="number">1000</span> * <span class="number">12</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// twelve seconds later</span></span><br><span class="line">    <span class="comment">// https://www.youtube.com/watch?v=qIX1BhvUMJ0</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Aye, aye, Capt\'n!!!'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<pre>

</pre>

<p><strong>How?</strong> Promises are a part of the ES6  specification <a href="#[2]">[2]</a>. This means they are available natively in implementations of the spec or alternatively, for environments that haven’t caught up yet <a href="#[3]">[3]</a>, in a plethora of third-party libraries <a href="#[4]">[4]</a>. My favourite is bluebird for its fantastic array of features and the famous <code>promisify</code> function <a href="#[5]">[5,6]</a>. To run the examples given in this article I suggest copy-pasting into the Chrome developer console.</p>
<hr>
<p><span id="section2"></span></p>
<h2 id="2-_Ponderings">2. Ponderings</h2><p>As humans we are all Ponderlings, each of us accustomed to a good old ponder now and again. It is the lifeblood of momentum in learning and carries us from bemused dumb-brains to clever-little-things. Here are some ponderings that I pondered as a Promise Ponderling… I hope that made sense… and I hope they will help you.</p>
<p><span id="section2.1"></span></p>
<h4 id="2-1_“What_do_resolve_and_reject_mean?”">2.1 “What do <code>resolve</code> and <code>reject</code> mean?”</h4><p>To understand what these terms mean we only have to consider why Promises borrow their name from their real-world counterpart, whose purpose is as an <em>assurance mechanism</em>. In the real-world a promise has two outcomes: that the assurance is fulfilled, or it is unfulfilled. We can map the actions <code>resolve</code> and <code>reject</code> as arbiters of each outcome, respectively:</p>
<pre>
    ACTION   =>   OUTCOME
    -------------------------
    resolve  =>   fulfilled
    reject   =>   unfulfilled

</pre>

<p><span id="section2.2"></span></p>
<h4 id="2-2_“What_is_the_difference_between_new_Promise()_and_Promise#then?”">2.2 “What is the difference between <code>new Promise()</code> and <code>Promise#then</code>?”</h4><p>We can create a new <em>assurance</em> by using <code>new Promise()</code>. The function that <code>Promise</code> accepts will eventually call either the <code>resolve</code> or <code>reject</code> functions, which are given as arguments. <code>Promise#then</code> is an instance method, allowing you to accept the result or failure of a Promise while itself returning a new Promise. As a result we can chain calls to <code>then</code>, each invoked when its immediate ancestor has resolved or rejected. It is this chaining that cleverly brings asynchronous architecture back to the familiar linear behaviour of synchronous development.</p>
<figure class="highlight js"><figcaption><span>Creating and accepting the result of a Promise</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create a new 'assurance'</span></span><br><span class="line"><span class="comment">// ------------------------</span></span><br><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    resolve(<span class="string">'Assurance fulfilled!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Attach a 'listener' to accept the success of the assurance</span></span><br><span class="line"><span class="comment">// ----------------------------------------------------------</span></span><br><span class="line">promise.then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(result); <span class="comment">// =&gt; 'Assurance fulfilled!'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<pre>

</pre>

<p><span id="section2.3"></span></p>
<h4 id="2-3_“What_can_I_give_Promise#then?_Does_it_accept_a_new_Promise?”">2.3 “What can I give <code>Promise#then</code>? Does it accept a <code>new Promise</code>?”</h4><p>The <code>then</code> method accepts two <em>callables</em>: a handler for success and a handler for ‘catching’ errors (read on a few questions to find out <em>what</em> errors). Both callables are handed a single value on invocation. If you don’t give <code>then</code> a callable the Promise will resolve immediately to the previous Promise’s value. <code>new Promise(...)</code> is not a callable, and so this rule will come into effect.</p>
<figure class="highlight js"><figcaption><span>Well, well, well... what do we have here then?</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> promise1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    resolve(<span class="string">'Hello, World!'</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(result); <span class="comment">// =&gt; 'Hello, World!'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> promise2 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    resolve(<span class="string">'Hello, World!'</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.then(</span><br><span class="line">    <span class="comment">// incorrectly give a Promise</span></span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">        resolve(<span class="string">'In b4 Hello, World!'</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(result); <span class="comment">// =&gt; 'Hello, World!'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<pre>

</pre>

<p><span id="section2.4"></span></p>
<h4 id="2-4_“What_happens_if_I_don’t_resolve_a_Promise?”">2.4 “What happens if I don’t <code>resolve</code> a <code>Promise</code>?”</h4><p>Then you take it to your grave! (Or to Promise Hell?) But really, <em>nothing happens</em>. Execution will not be passed to the next <code>then</code> and your Promise chain will become ‘stuck’.</p>
<figure class="highlight js"><figcaption><span>Hang on to your resolve</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Attempt to resolve by conventionally returning</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello, World!'</span> <span class="comment">// echo... echo... echo...</span></span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// never invoked</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'result'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><span></span></p>
<p>However don’t forget that inside a <code>then</code> success handler, you can return any value to pass execution on to the next <code>then</code> in the Promise chain:</p>
<figure class="highlight js"><figcaption><span>Say hi, World</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">helloWorld</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">        resolve(<span class="string">'Hello, World!'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">helloWorld()</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> result; <span class="comment">// =&gt; pass 'Hello, World!' to the next handler</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(result); <span class="comment">// =&gt; 'Hello, World!'</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<pre>

</pre>

<p><span id="section2.5"></span></p>
<h4 id="2-5_“What_affect_does_rejecting_a_Promise_have?”">2.5 “What affect does <code>reject</code>ing a Promise have?”</h4><p>Rejecting a Promise will invoke the next available error handler supplied with <code>then</code>.</p>
<figure class="highlight js"><figcaption><span>It isn't you, it's me...</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rejectPromise</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">        reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Error! Error!'</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Supplying both success and error handlers</span></span><br><span class="line"><span class="comment">// -----------------------------------------</span></span><br><span class="line">rejectPromise()</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// never invoked</span></span><br><span class="line">        <span class="built_in">console</span>.log(result);</span><br><span class="line">    &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err); <span class="comment">// =&gt; Error: 'Error! Error!'</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Supplying just an error handler</span></span><br><span class="line"><span class="comment">// -------------------------------</span></span><br><span class="line">rejectPromise()</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// never invoked</span></span><br><span class="line">        <span class="built_in">console</span>.log(result);</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(</span><br><span class="line">        <span class="literal">null</span>, <span class="comment">// no success handler given</span></span><br><span class="line">        <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(err); <span class="comment">// =&gt; Error: 'Error! Error!'</span></span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"><span class="comment">// Catching an error using the `catch` method on a Promise</span></span><br><span class="line"><span class="comment">// -------------------------------------------------------</span></span><br><span class="line">rejectPromise()</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err); <span class="comment">// =&gt; Error: 'Error! Error!'</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<pre>

</pre>

<p><span id="section2.6"></span></p>
<h4 id="2-6_“If_I_throw_an_Error,_where_will_it_go?”">2.6 “If I <code>throw</code> an Error, where will it go?”</h4><p>It’s up to you to give errors a place to go by supplying an error handler using <code>then</code>. You can supply an error handler with each call to <code>then</code>, but the handler will only be invoked when an error occurs before <strong>and</strong> outside of its own <code>then</code>.</p>
<figure class="highlight js"><figcaption><span>Indiana Jones and the Search for the Lost Error</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(functiion(resolve, reject) &#123;</span><br><span class="line">    <span class="comment">// (1)</span></span><br><span class="line">    resolve(<span class="string">'ONE'</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// (2)</span></span><br><span class="line">    <span class="built_in">console</span>.log(result); <span class="comment">// =&gt; 'ONE'</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Error! Error!'</span>);</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// never invoked because (1) doesn't throw an Error</span></span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// never invoked because (2) throws an Error</span></span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// (2)'s error is caught here</span></span><br><span class="line">    <span class="built_in">console</span>.log(err); <span class="comment">// =&gt; Error: 'Error! Error!'</span></span><br><span class="line">&#125;)</span><br><span class="line">.then(</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Another Error! Run for it!'</span>); <span class="comment">// This Error has nowhere to go...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// no error handler</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<pre>

</pre>

<p><span id="section2.7"></span></p>
<h4 id="2-7_“Should_I_throw_an_Error_in_a_new_Promise()_or_call_the_reject_function?”">2.7 “Should I <code>throw</code> an Error in a <code>new Promise()</code> or call the <code>reject</code> function?”</h4><p>It depends. Throwing an error will stop execution within the function but calling <code>reject</code> will not stop execution. However both will mark the Promise as ‘rejected’ so you cannot perform both and expect the error handler to be called twice. An error handler will only ever be called once.</p>
<figure class="highlight js"><figcaption><span>Should I stay or should I throw now...</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Allow execution to continue by calling reject</span></span><br><span class="line"><span class="comment">// ---------------------------------------------</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    reject(<span class="string">'Error! Error!'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Keep on keeping on...'</span>); <span class="comment">// this is still called</span></span><br><span class="line">&#125;)</span><br><span class="line">.then(</span><br><span class="line">    <span class="literal">null</span>, <span class="comment">// no success handler</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err); <span class="comment">// =&gt; Error: 'Error! Error!'</span></span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Prevent execution from continuing by throwing</span></span><br><span class="line"><span class="comment">// ---------------------------------------------</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Error! Error!'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Silence...'</span>); <span class="comment">// never invoked</span></span><br><span class="line">&#125;)</span><br><span class="line">.then(</span><br><span class="line">    <span class="literal">null</span>, <span class="comment">// no success handler</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err); <span class="comment">// =&gt; Error: 'Error! Error!'</span></span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><span></span></p>
<p>If you are calling a non-callback and non-Promise procedure that isn’t in your control and that throws an error traditionally, you can wrap it in a try/catch block. (Read the next question to understand why you cannot do this for a procedure that throws an error asynchronously - this will almost never be the case; it will instead ask for an error-first callback or return a Promise.)</p>
<figure class="highlight js"><figcaption><span>If at first you don't succeed, try and catch again</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// this throws Error('Error! Error!') synchronously</span></span><br><span class="line">        syncThrow();</span><br><span class="line">    &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">        reject(err);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">.then(</span><br><span class="line">    <span class="literal">null</span>, <span class="comment">// no success handler</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err); <span class="comment">// =&gt; Error: 'Error! Error!'    </span></span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<pre>

</pre>

<p><span id="section2.8"></span></p>
<h4 id="2-8_“Is_throwing_the_same_as_rejecting?”">2.8 “Is <code>throw</code>ing the same as <code>reject</code>ing?”</h4><p>No. But yes. To the handler, there will be no difference, however you cannot <code>throw</code> asynchronously! This is why we are given the <code>reject</code> function to begin with! Placing an asynchronous operation within a try/catch does not guarantee that a thrown error will be caught by the catch block, because the asynchronous procedure will actually execute <em>outside of the try block</em>.</p>
<figure class="highlight js"><figcaption><span>Is throwing the same as rejecting?</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Attempt to catch an asynchronously thrown error using traditional try/catch block</span></span><br><span class="line"><span class="comment">// ---------------------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// this throws Error('Error! Error!') asynchronously</span></span><br><span class="line">    asyncThrow();</span><br><span class="line">&#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">    <span class="comment">// never invoked</span></span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Attempt to catch an asynchronously thrown error within a Promise</span></span><br><span class="line"><span class="comment">// ----------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        asyncThrow(); <span class="comment">// this throws Error('Error! Error!')</span></span><br><span class="line">    &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">        <span class="comment">// pass `err` onto the error handler below</span></span><br><span class="line">        <span class="comment">// ...doesn't work as seen above!</span></span><br><span class="line">        reject(err);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">.then(</span><br><span class="line">    <span class="literal">null</span>, <span class="comment">// no success handler</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// never invoked because the error above</span></span><br><span class="line">        <span class="comment">// was never caught...</span></span><br><span class="line">        <span class="built_in">console</span>.log(err); </span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<pre>

</pre>

<p><span id="section2.9"></span></p>
<h4 id="2-9_“Why_isn’t_my_Promise‘s_error_handler_being_invoked?”">2.9 “Why isn’t my <code>Promise</code>‘s error handler being invoked?”</h4><p>A common mistake when first starting to use Promises is placing the handler for catching errors within the same call to <code>then</code> where one of those errors may be thrown.</p>
<figure class="highlight js"><figcaption><span>Good catch!</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">    resolve(<span class="string">'Nothing to see here... '</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(result + <span class="string">' Error! Error!'</span>);</span><br><span class="line">    <span class="comment">// or Promise.reject(result + ' Error! Error!');</span></span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// never invoked</span></span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">&#125;)</span><br><span class="line">.then(</span><br><span class="line">    <span class="literal">null</span>, <span class="comment">// no success handler given</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err); <span class="comment">// =&gt; 'Nothing to see here... Error! Error!'</span></span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<pre>

</pre>

<p><span id="section2.10"></span></p>
<h4 id="2-10_“Why_is_my_Promise_‘pending’_when_I_have_already_resolved_it?”">2.10 “Why is my <code>Promise</code> ‘pending’ when I have already resolved it?”</h4><p>This is my most ‘pondiferous’ finding (or <em>interesting</em> for those less versed than I in the language of Ponderers): all Promise handlers are executed asynchronously! What does this mean? Let’s take a look…</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> p = <span class="built_in">Promise</span>.resolve().then(<span class="keyword">new</span> <span class="built_in">Array</span>()); <span class="comment">// (1)</span></span><br><span class="line"><span class="built_in">console</span>.log(p); <span class="comment">// (2) status: PENDING</span></span><br><span class="line"><span class="comment">// ...wait...</span></span><br><span class="line"><span class="built_in">console</span>.log(p); <span class="comment">// (3) status: RESOLVED</span></span><br></pre></td></tr></table></figure>
<p><span></span></p>
<p><strong>What’s going on?</strong> </p>
<p><em>(1)</em> We create a resolved Promise using <code>Promise#resolve</code> and attempt to create a handler to accept the success of this Promise, but give it a a <em>non-callable</em>. In this case, a <code>new Array</code>.</p>
<p><em>(2)</em> Then log the return of the statement (<a href="https://i.imgur.com/iQSFpPo.jpg" target="_blank" rel="external">add both 1 and 2 to the call stack <em>at the same time</em></a>). This executes <em>before</em> the Promise attempts to call the success handler given to it with <code>Promise#then</code>, as a Promise waits for the call stack to be empty before invoking all handlers. </p>
<p><em>(3)</em> Finally, once the call stack is empty, the Promise resolves as it accepts the result of the call to <code>Promise#resolve</code> because a <code>new Array</code> is not <em>callable</em>.</p>
<p><span id="section2.11"></span></p>
<h4 id="2-11_“Generally,_what_rules_should_I_follow_for_handling_errors?”">2.11 “Generally, what rules should I follow for handling errors?”</h4><p><strong>Always</strong> catch errors using the <code>Promise#catch</code> instance method at the end of any Promise chain.</p>
<figure class="highlight js"><figcaption><span>Gotta catch `em all!</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">saveUser()</span><br><span class="line">    .then(notifyUserOfSuccess)</span><br><span class="line">    .catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">        logError(err);</span><br><span class="line">        notifyUserOfError(err);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p><span></span></p>
<p>And throw errors where they useful to the user or for debugging. If something has failed to save and you are auditing, for example, do you need to tell the user that it failed to save <em>half-way</em> through the process? Or just that it has failed to save altogether? Probably the former is most appropriate for debugging and the latter for the user.</p>
<hr>
<p><span id="section3"></span></p>
<h2 id="3-_Patterns">3. Patterns</h2><p>The Promise object has a number of static and instance methods that used together with methods available on other objects within the JavaScript global namespace (e.g. Array) allow us to create powerful aysnchronous behaviour. We call these <em>patterns</em> as these behaviours will be used multiple times within a single application and across any number of independent applications.</p>
<p><span id="section3.1"></span></p>
<h3 id="3-1_Batching_with_Array#map_and_Promise-all">3.1 Batching with <code>Array#map</code> and <code>Promise.all</code></h3><p>It is quite common to want an action performed after two or more other actions complete. Often you will be performing the <em>same operation</em> multiple times with <em>different arguments</em>.</p>
<p><strong>How?</strong> You may have come across the <code>Array#map</code> method already. It’s a great way of turning a collection of things into a collection of other things. As an example, let’s turn an array of incorrectly spelt words into an array of Promises that will ‘spell-check’ each word and return the correct word. We will then use <code>Promise#all</code> to log the result of each Promise, but only once each Promise has been resolved.</p>
<figure class="highlight js"><figcaption><span>The Not-really-spell-checking Spell Checker</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> promises = [<span class="string">'Wunt'</span>, <span class="string">'Hullo'</span>, <span class="string">'Sunt'</span>, <span class="string">'Lut'</span>].map(<span class="function"><span class="keyword">function</span>(<span class="params">word</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> correctSpelling = word.replace(<span class="regexp">/u/</span>, <span class="string">'e'</span>);</span><br><span class="line">        setTimeout(resolve.bind(<span class="literal">null</span>, correctSpelling));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.all(promises).then(<span class="function"><span class="keyword">function</span>(<span class="params">words</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(words); <span class="comment">// =&gt; Array['Hello', 'Went', 'Spent', 'Let']</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><span id="section3.2"></span></p>
<h3 id="3-2_Clean_Chaining">3.2 Clean Chaining</h3><p>Write clean code by chaining function references instead of giving anonymous handlers to <code>then</code>. By giving a function reference at each step of the way you can make it much clearer what the code is doing to whoever is reading your code.</p>
<figure class="highlight js"><figcaption><span>Chaining Function References</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">validateNewUser(user)</span><br><span class="line">    .then(saveUser)</span><br><span class="line">    .then(notifySuccess)</span><br><span class="line">    .then(redirectUserToDashboard);</span><br></pre></td></tr></table></figure>
<p><span id="section3.3"></span></p>
<h3 id="3-3_Throwing_Instead_of_Rejecting">3.3 Throwing Instead of Rejecting</h3><p>If you are writing large applications you might find it useful to start throwing errors traditionally instead of calling <code>Promise#reject</code> when an error occurs. The best reasons I can think of for adopting this pattern are that <em>(1)</em> you can write custom Errors and <em>(2)</em> you don’t have to remember to call <code>Promise#reject</code>.</p>
<figure class="highlight js"><figcaption><span>Throwing Custom Errors</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateUserCredentials</span>(<span class="params">username, password</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> database</span><br><span class="line">        .findUser(username, password)</span><br><span class="line">        .then(<span class="literal">null</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidationError(); <span class="comment">// custom Error</span></span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre>

</pre>

<hr>
<p><span id="section4"></span></p>
<h2 id="4-_Anti-patterns">4. Anti-patterns</h2><p>Anti-patterns are the charlatan of the programming world - created when a particular programming tool or construct is used to solve the wrong problem whilst doing so in a semantic and seemingly ‘complete’ manner, they of course appear to lack any negative consequence, but in reality will have subtle and potentially harmful side-effects. Promises aren’t invulnerable to the lure of the anti-pattern, so here are some to be aware of.</p>
<p><span id="section4.1"></span></p>
<h3 id="4-1_Deferring_a_Promise">4.1 Deferring a Promise</h3><p>A common mistake made when starting out using Promises is wrapping a Promise-aware procedure in a <em>defer</em> <a href="#[7]">[7]</a>. This happened to me when I was made fimilar with deferreds before I was aware of Promises (even though Deferreds inherit from Promises!). The largest issue created by this anti-pattern is that errors become lost, meaning your application could fail unexpectedly or the user is left waiting indefinitely for an action to complete that has actually errored. Another is that you are over-complicating your code, potentially confusing other developers.</p>
<figure class="highlight js"><figcaption><span>Inadvertently deferring a Promise</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">promisifyString</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wrappedPromise</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> defer = Q.defer();</span><br><span class="line">    </span><br><span class="line">    promisifyString(<span class="string">'Hello, World!'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">        defer.resolve(result);</span><br><span class="line">    &#125;);</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> defer.promise;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wrappedPromise().then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(result); <span class="comment">// =&gt; 'Hello, World!'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><span></span></p>
<p>The above is exactly the same as doing:</p>
<figure class="highlight js"><figcaption><span>Correctly using a Promise-aware function</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">promisifyString(<span class="string">'Hello, World!'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(result); <span class="comment">// =&gt; 'Hello, World!'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><span></span></p>
<p>This might seem obvious, but that’s because I have defined the function that we are wrapping. If you <em>don’t know</em> that the function you are inadvertently wrapping returns a Promise then this anti-pattern might catch you out.</p>
<p><span id="section4.2"></span></p>
<h3 id="4-2_Nesting_Promises">4.2 Nesting Promises</h3><p>Promises are made to take us away from nesting, but you will often find Promises nested within each other callback-style. The problem here is that it means by using Promises we are no longer solving the fundamental architectural issue from which they are borne.</p>
<figure class="highlight js"><figcaption><span>Nesting Promises</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeHelloUniverse</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">    str = str.replace(<span class="regexp">/World/</span>, <span class="string">'Universe'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">promisifyString(<span class="string">'Hello, World!'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">    makeHelloUniverse(result).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(result); <span class="comment">// =&gt; 'Hello, Universe!'</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><span></span></p>
<p>The correct way to approach this would be:</p>
<figure class="highlight js"><figcaption><span>Avoiding nesting with Promises</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">promisifyString(<span class="string">'Hello, World!'</span>)</span><br><span class="line">    .then(makeHelloUniverse) <span class="comment">// pass the function in by reference</span></span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(result); <span class="comment">// =&gt; 'Hello, Universe!'</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p><span id="section4.3"></span></p>
<h3 id="4-3_The_Non-Returning_Promise">4.3 The Non-Returning Promise</h3><p>To chain Promises you must pass a result by returning <em>something</em> from a handler: a value or another Promise. This may not be an issue if a Promise does not actually pass on any data, but it may cause some confusion for developers (or you, a month down the line) who do intend to pick up the result of that Promise later on. This is demonstrated quite easily if we rewrite our <code>makeHelloUniverse</code> function.</p>
<figure class="highlight js"><figcaption><span>A non-chainable Promise</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeHelloUniverse</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">    str = str.replace(<span class="regexp">/World/</span>, <span class="string">'Universe'</span>);</span><br><span class="line">    <span class="built_in">Promise</span>.resolve(str); <span class="comment">// NO RETURN STATEMENT</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">makeHelloUniverse(<span class="string">'Hello, World!'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// never invoked</span></span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<pre>

</pre>

<hr>
<p><span id="section5"></span></p>
<h2 id="5-_Apologies">5. Apologies</h2><p>Apologies to those who didn’t find an answer to their question here. Ask it in the comments and I will do my best to answer it. Or even better… ask StackOverflow <a href="#[8]">[8]</a>! If you’re starting out, lots of these examples will be confusing and may even make you feel like you’re taking a few steps back. Try using Promises ‘in the wild’, make mistakes, and you will soon start to understand them regardless of what you read on the web. Practically they appear difficult, but conceptually they are really quite simple.</p>
<hr>
<p><span id="section6"></span></p>
<h2 id="6-_References">6. References</h2><p><span id="[1]">[1]</span> <a href="http://callbackhell.com/" target="_blank" rel="external">Callback Hell</a><br><span id="[2]">[2]</span> <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-promise-objects" target="_blank" rel="external">ECMAScript 2015: Promise specification</a><br><span id="[3]">[3]</span> <a href="https://kangax.github.io/compat-table/es6/" target="_blank" rel="external">ES6 compatibility table</a><br><span id="[4]">[4]</span> <a href="http://complexitymaze.com/2014/03/03/javascript-promises-a-comparison-of-libraries/" target="_blank" rel="external">A comparison of JavaScript Promise libraries</a><br><span id="[5]">[5]</span> <a href="https://github.com/petkaantonov/bluebird" target="_blank" rel="external">Bluebird Promise library</a><br><span id="[6]">[6]</span> <a href="https://github.com/petkaantonov/bluebird/blob/master/API.md#promisification" target="_blank" rel="external">Bluebird promisification documentation</a><br><span id="[7]">[7]</span> <a href="https://github.com/kriskowal/q#using-deferreds" target="_blank" rel="external">“Using Deferreds” from Q documentation</a><br><span id="[8]">[8]</span> <a href="http://stackoverflow.com/questions/tagged/promise" target="_blank" rel="external">StackOverflow ‘promise’ tag questions</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p>If you aren’t familiar with Promises or you have used them but don’t know <em>why</em>, then I hope this article will help you. Because “]]>
    </summary>
    
      <category term="es2015" scheme="sdgluck.github.io/tags/es2015/"/>
    
      <category term="javascript" scheme="sdgluck.github.io/tags/javascript/"/>
    
      <category term="node" scheme="sdgluck.github.io/tags/node/"/>
    
      <category term="promise" scheme="sdgluck.github.io/tags/promise/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[What is a Key Mirror?]]></title>
    <link href="sdgluck.github.io/2015/08/12/key-mirrors/"/>
    <id>sdgluck.github.io/2015/08/12/key-mirrors/</id>
    <published>2015-08-12T16:16:00.000Z</published>
    <updated>2015-08-16T12:02:15.539Z</updated>
    <content type="html"><![CDATA[<p>It is very likely that in your day-to-day JavaScript programming you will have encountered the problem that is ‘how can I maintain a collection of constants in the form of string literals, and reference these strings by a name?’ If you have posed this question, and are still waiting for an answer, then I am happy to give it to you: key mirrors.</p>
<h2 id="What_is_a_key_mirror?">What is a key mirror?</h2><p>A key mirror is an object where for each property, the key is the same as the value. They are most useful as a collection of constants that ‘give back’ their own definition, and many languages already provide an integrated solution for this behaviour in the form of an <a href="https://en.wikipedia.org/wiki/Enumerated_type" target="_blank" rel="external">enum</a>. Unfortunately, JavaScript doesn’t… so we use ‘key mirrors’ instead.</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attribute">SOME_USEFUL_CONST</span>: <span class="string">'SOME_USEFUL_CONST'</span>,</span><br><span class="line">    <span class="attribute">ANOTHER_USEFUL_CONST</span>: <span class="string">'ANOTHER_USEFUL_CONST'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="When_should_I_use_a_key_mirror?">When should I use a key mirror?</h2><p>Key mirrors are useful for a number of reasons of course, so here are some use-cases where key mirrors will help you out:</p>
<p><strong>Auto-completion:</strong> You want your IDE to auto-complete string literals that are common in your code. Introducing key mirrors for this purpose will help you avoid nasty typos that are otherwise inevitable, especially if you are working with a team of developers.</p>
<p><strong>Time-saving and consolidation:</strong> You find yourself typing multiple string literals more than once, and they serve a common purpose.</p>
<p><strong>Check for legality of a value:</strong> You want to easily check that a value is ‘legal’ by using that value as a key in the keyMirror.</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var COLOURS = &#123;<span class="built_in">red</span>: <span class="string">'red'</span>, <span class="built_in">green</span>: <span class="string">'green'</span>, <span class="built_in">blue</span>: <span class="string">'blue'</span>&#125;;</span><br><span class="line">var colour = COLOURS.<span class="built_in">red</span>;</span><br><span class="line">var legalValue = !!COLOURS[colour];</span><br></pre></td></tr></table></figure>
<p><span style="height: 8px;"></span><br><strong>Track original key</strong> <a href="https://sdgluck.github.io/2015/08/12/key-mirrors/#comment-2196343745"><em>(From Jordan, Pioneering Inventor of the keyMirror)</em></a>: don’t forget the benefit of being able to track the original <em>key</em> that was used to generate the value in logs or debugging. If COLOURS is a keyMirror, then the value tracks its original key name, whereas if it’s a mapping from keys to integers, you have to consult some far removed piece of code to recall what original concept that number was mapped from.</p>
<figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSomething</span><span class="params">(val)</span> &#123;</span></span><br><span class="line">    <span class="comment">// What is val?</span></span><br><span class="line">    console.<span class="built_in">log</span><span class="params">(val)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">doSomething<span class="params">(COLOURS.red)</span>;</span><br></pre></td></tr></table></figure>
<h2 id="How_do_I_create_a_key_mirror?">How do I create a key mirror?</h2><p>As always, there is more than one solution. So here are a few… take your pick!</p>
<h3 id="Using_React">Using React</h3><p>The React library comes packaged with a key mirror helper module, <code>react/utils/keyMirror</code>.</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="reserved">var</span> keyMirror = <span class="built_in">require</span>(<span class="string">'react/utils/keyMirror'</span>);</span><br><span class="line"><span class="reserved">var</span> COLOURS = &#123;</span><br><span class="line">    <span class="attribute">red</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attribute">green</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attribute">blue</span>: <span class="literal">true</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="reserved">var</span> mirror = keyMirror(COLOURS);</span><br><span class="line"><span class="built_in">console</span>.log(mirror); <span class="regexp">//</span> &#123;<span class="attribute">red</span>: <span class="string">'red'</span>, <span class="attribute">green</span>: <span class="string">'green'</span>, <span class="attribute">blue</span>: <span class="string">'blue'</span>&#125;</span><br></pre></td></tr></table></figure>
<p>But if you aren’t using React, it’s easy to build your own:</p>
<h3 id="Using_lodash:">Using lodash:</h3><p>We can use the <code>_.reduce</code> method to take any Object or Array and create a key mirror from it. In the case of an Array, we take each element and use its value as the key and value. For an Object we do the same by first using the <code>Object.keys</code> method, which (unsurprisngly) returns an Array of an object’s keys.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">keyMirror</span>(<span class="params">keys</span>) </span>&#123;</span><br><span class="line">    keys = <span class="built_in">Array</span>.isArray(keys) ? keys : <span class="built_in">Object</span>.keys(keys);</span><br><span class="line">    <span class="keyword">return</span> _.reduce(keys, <span class="function"><span class="keyword">function</span>(<span class="params">res, v</span>) </span>&#123;</span><br><span class="line">        res[v] = v;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;, &#123;&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Using_JavaScript:">Using JavaScript:</h3><p>Or if you want to avoid using any libraries, perhaps as you think the other methods are overkill, then create your own from scratch:</p>
<figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">keyMirror</span><span class="params">(keys)</span> &#123;</span></span><br><span class="line">    keys = Array.isArray<span class="params">(keys)</span> ? keys : Object.keys<span class="params">(keys)</span>;</span><br><span class="line">    var <span class="built_in">mirror</span> = &#123;&#125;;</span><br><span class="line">    keys.forEach<span class="params">(v =&gt; mirror[v] = v)</span>;</span><br><span class="line">    return <span class="built_in">mirror</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Using_npm:">Using npm:</h3><p>Check out one of the many <a href="https://www.npmjs.com/search?q=keymirror" target="_blank" rel="external">key mirror libraries published on <code>npm</code></a>.</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>It is very likely that in your day-to-day JavaScript programming you will have encountered the problem that is ‘how can I maintain a coll]]>
    </summary>
    
      <category term="javascript" scheme="sdgluck.github.io/tags/javascript/"/>
    
      <category term="key mirror" scheme="sdgluck.github.io/tags/key-mirror/"/>
    
      <category term="node" scheme="sdgluck.github.io/tags/node/"/>
    
  </entry>
  
</feed>